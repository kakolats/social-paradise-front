<section class="mx-auto my-auto w-2/3 px-6 py-8">
    <div class="rounded-2xl border border-slate-200 bg-white/80 p-8 shadow-lg backdrop-blur">
        <h2 class="mb-6 text-3xl font-bold tracking-tight text-slate-900">
            {{ eventToEdit ? 'Modifier un événement' : 'Créer un événement' }}
        </h2>
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-8">
            <!-- Event infos -->
            <div class="grid gap-6 md:grid-cols-2">
                <div>
                    <label class="mb-1 block text-base font-medium text-slate-700">Nom de l'événement</label>
                    <input type="text" formControlName="name"
                           class="w-full rounded-xl border border-slate-300 px-4 py-2 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                    <p *ngIf="invalid('name')" class="mt-1 text-sm text-red-600">Nom requis (3+ caractères).</p>
                </div>

                <div>
                    <label class="mb-1 block text-base font-medium text-slate-700">Date de l'événement</label>
                    <input type="date" formControlName="date"
                           class="w-full rounded-xl border border-slate-300 px-4 py-2 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                    <p *ngIf="invalid('date')" class="mt-1 text-sm text-red-600">Date requise.</p>
                </div>

                <div>
                    <label class="mb-1 block text-base font-medium text-slate-700">Lieu de l'événement</label>
                    <input type="text" formControlName="location"
                           class="w-full rounded-xl border border-slate-300 px-4 py-2 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                    <p *ngIf="invalid('location')" class="mt-1 text-sm text-red-600">Lieu requis (3+ caractères).</p>
                </div>

                <div class="md:col-span-2">
                    <label class="mb-1 block text-base font-medium text-slate-700">Description</label>
                    <quill-editor
                        formControlName="description"
                        [placeholder]="'Décrivez l\'événement...'"
                        theme="snow"
                        class="rounded-xl border border-slate-300 focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10"
                    ></quill-editor>
                </div>
            </div>

            <!-- Cover image -->
            <div class="space-y-4">
                <div>
                    <label class="mb-1 block text-base font-medium text-slate-700">Image de couverture</label>

                    <!-- Preview current cover if exists -->
                    <div *ngIf="form.controls.coverImage.value" class="mb-3">
                        <p class="text-xs text-slate-500 mb-2">Image actuelle :</p>
                        <img [src]="form.controls.coverImage.value"
                             alt="cover"
                             class="max-h-40 w-auto rounded-xl border border-slate-200 object-cover shadow-sm" />
                    </div>

                    <input type="file"
                           accept="image/*"
                           (change)="onCoverFileChange($event)"
                           class="block w-full text-sm text-slate-600 file:mr-4 file:rounded-lg file:border-0 file:bg-[#d36b3d] file:px-4 file:py-2 file:text-white file:font-semibold file:hover:opacity-90 file:cursor-pointer cursor-pointer" />

                    <p class="mt-2 text-xs text-slate-500">
                        Choisissez une image. Elle sera téléversée puis utilisée comme couverture.
                    </p>
                </div>
            </div>

            <!-- Prices -->
            <div>
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-slate-900">Plages de prix</h3>
                    <div class="flex gap-2">
                        <button type="button" (click)="addPrice()"
                                class="rounded-xl bg-[#d36b3d] px-4 py-2 text-sm font-semibold text-white hover:opacity-90">
                            + Ajouter un prix
                        </button>
                    </div>
                </div>

                <div *ngIf="prices().length === 0" class="rounded-xl border border-dashed border-slate-300 p-6 text-center text-slate-500">
                    Aucun prix ajouté
                </div>

                <div *ngIf="prices().length > 0" class="overflow-hidden rounded-2xl border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200 text-sm">
                        <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Nom</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Montant (XOF)</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Début</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Fin</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Actions</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                        <tr *ngFor="let p of prices().controls; let i = index; trackBy: trackByIndex" [formGroup]="p">
                            <td class="px-4 py-3">
                                <input type="text" formControlName="name"
                                       class="w-full rounded-lg border border-slate-300 px-3 py-1.5 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                                <p *ngIf="p.controls.name.touched && p.controls.name.invalid" class="mt-1 text-xs text-red-600">
                                    Nom requis
                                </p>
                            </td>

                            <td class="px-4 py-3">
                                <input type="number" formControlName="amount" min="0"
                                       class="w-full rounded-lg border border-slate-300 px-3 py-1.5 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                                <p *ngIf="p.controls.amount.touched && p.controls.amount.invalid" class="mt-1 text-xs text-red-600">
                                    Montant requis (≥ 0)
                                </p>
                            </td>

                            <td class="px-4 py-3">
                                <input type="date" formControlName="startDate"
                                       class="w-full rounded-lg border border-slate-300 px-3 py-1.5 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                                <p *ngIf="i > 0 && (p.controls.startDate.touched || p.touched) && startNotAfterPrevEnd(i)"
                                   class="mt-1 text-xs text-red-600">
                                    Le début doit être strictement après la fin du prix précédent.
                                </p>
                            </td>

                            <td class="px-4 py-3">
                                <input type="date" formControlName="endDate"
                                       class="w-full rounded-lg border border-slate-300 px-3 py-1.5 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                                <p *ngIf="p.touched && !rangeValid(p)" class="mt-1 text-xs text-red-600">Fin doit être ≥ début</p>
                                <p *ngIf="(p.controls.endDate.touched || p.touched) && endAfterEvent(i)" class="mt-1 text-xs text-red-600">
                                    La fin doit être ≤ la date de l'événement.
                                </p>
                            </td>

                            <td class="px-4 py-3">
                                <button type="button" (click)="removePrice(i)"
                                        class="rounded-lg bg-rose-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:opacity-90">
                                    Supprimer
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tables -->
            <div>
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-slate-900">Types de tables</h3>
                    <div class="flex gap-2">
                        <button type="button"
                                (click)="addTable()"
                                class="rounded-xl bg-[#d36b3d] px-4 py-2 text-sm font-semibold text-white hover:opacity-90">
                            + Ajouter une table
                        </button>
                    </div>
                </div>

                <div *ngIf="tables().length === 0"
                     class="rounded-xl border border-dashed border-slate-300 p-6 text-center text-slate-500">
                    Aucune table ajoutée
                </div>

                <div *ngIf="tables().length > 0" class="overflow-hidden rounded-2xl border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200 text-sm">
                        <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Nom</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Montant (XOF)</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Capacité</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Actions</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                        <tr *ngFor="let t of tables().controls; let i = index; trackBy: trackByIndex" [formGroup]="t">
                            <td class="px-4 py-3">
                                <input type="text" formControlName="name"
                                       class="w-full rounded-lg border border-slate-300 px-3 py-1.5 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                                <p *ngIf="t.controls.name.touched && t.controls.name.invalid" class="mt-1 text-xs text-red-600">
                                    Nom requis
                                </p>
                            </td>

                            <td class="px-4 py-3">
                                <input type="number" formControlName="amount" min="0" step="1"
                                       class="w-full rounded-lg border border-slate-300 px-3 py-1.5 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                                <p *ngIf="t.controls.amount.touched && t.controls.amount.invalid" class="mt-1 text-xs text-red-600">
                                    Montant ≥ 0
                                </p>
                            </td>

                            <td class="px-4 py-3">
                                <input type="number" formControlName="capacity" min="1"
                                       class="w-full rounded-lg border border-slate-300 px-3 py-1.5 shadow-sm focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10" />
                                <p *ngIf="t.controls.capacity.touched && t.controls.capacity.invalid" class="mt-1 text-xs text-red-600">
                                    Capacité ≥ 1
                                </p>
                            </td>

                            <td class="px-4 py-3">
                                <button type="button" (click)="removeTable(i)"
                                        class="rounded-lg bg-rose-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:opacity-90">
                                    Supprimer
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3">
                <button type="button" (click)="reset()"
                        class="rounded-xl border border-slate-300 bg-white px-5 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
                    {{ eventToEdit ? 'Annuler les modifications' : 'Réinitialiser' }}
                </button>
                <button type="submit"
                        [disabled]="submitting || form.invalid || !allRangesValid() || !allBusinessValid()"
                        class="rounded-xl bg-[#d36b3d] px-6 py-2 text-sm font-semibold text-white shadow hover:opacity-90 disabled:opacity-50">
                    {{ eventToEdit ? 'Mettre à jour' : 'Créer' }}
                </button>
            </div>

            <!-- Feedback -->
            <div *ngIf="createdMessage()" class="mt-4 rounded-xl border border-emerald-300 bg-emerald-50 p-4 text-emerald-800">
                ✅ {{ createdMessage() }}
            </div>
            <div *ngIf="errorMessage()" class="mt-4 rounded-xl border border-rose-300 bg-rose-50 p-4 text-rose-800">
                ❌ {{ errorMessage() }}
            </div>
        </form>
    </div>
</section>
